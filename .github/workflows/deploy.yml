name: CI/CD

on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Run tests
        run: npm test

  build-deploy:
    needs: test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Build project
        run: npm run build

      - name: Deploy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          source: 'dist,package.json,package-lock.json,prisma,ecosystem.config.js,docker-compose.yml'
          target: '/var/www/1fin'
          overwrite: true

      - name: Setup env and restart app
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            # Load NVM and Node.js
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

            cd /var/www/1fin

            # Create .env file from secrets
            echo "${{ secrets.ENV_VARIABLES }}" > .env

            # Load .env into environment
            set -a
            source .env
            set +a

            # Debug: check files
            echo "Files in /var/www/1fin:"
            ls -la
            echo "Files in dist:"
            ls -la dist/ || echo "dist folder not found"

            # Start/restart Docker services
            docker compose up -d

            # Wait for database to be ready
            sleep 10

            # Install production dependencies
            npm ci --omit=dev

            # Generate Prisma client and run migrations
            npx prisma generate
            npx prisma migrate deploy
            npx prisma db seed

            # Restart application with PM2
            pm2 restart ecosystem.config.js || pm2 start ecosystem.config.js
            pm2 save
