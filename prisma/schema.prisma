generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

// System roles (all users have a role)
enum SystemRole {
  FIN_DIRECTOR     // SuperAdmin - full system control
  FIN_ADMIN        // System manager
  FIN_EMPLOYEE     // Operational employee
  CLIENT_FOUNDER   // Client investor, monitoring role
  CLIENT_DIRECTOR  // Client company director
  CLIENT_EMPLOYEE  // Client company employee
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
}

enum FileStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum FileType {
  IMAGE
  DOCUMENT
  VOICE
  OTHER
}

enum MessageType {
  TEXT
  FILE
  VOICE
  DOCUMENT_FORWARD // Forward requires: target department, document number, comment
}

enum DocumentStatus {
  PENDING
  ACCEPTED
  REJECTED
  AUTO_EXPIRED // 10 days without action
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id                   String     @id @default(cuid())
  username             String     @unique
  password             String
  name                 String
  phone                String?
  avatar               String?
  systemRole           SystemRole @map("system_role") // Required for all users
  notificationsEnabled Boolean    @default(true) @map("notifications_enabled") // CLIENT_FOUNDER can disable
  mustChangePassword   Boolean    @default(false) @map("must_change_password")
  isActive             Boolean    @default(true) @map("is_active")
  createdAt            DateTime   @default(now()) @map("created_at")
  updatedAt            DateTime   @updatedAt @map("updated_at")

  // Relations
  memberships       UserCompanyMembership[]
  sessions          Session[]
  sentMessages      Message[]              @relation("SentMessages")
  files             File[]
  notifications     Notification[]
  createdDocuments  Document[]             @relation("DocumentCreator")
  approvedDocuments Document[]             @relation("DocumentApprover")

  @@map("users")
}

model Session {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  deviceName   String   @map("device_name")
  deviceType   String   @map("device_type")
  refreshToken String   @map("refresh_token")
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  lastActiveAt DateTime @default(now()) @map("last_active_at")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// ============================================
// COMPANY & MEMBERSHIP
// ============================================

model Company {
  id          String   @id @default(cuid())
  name        String
  description String?
  inn         String?  @unique
  logo        String?
  address     String?
  requisites  Json?
  isActive    Boolean  @default(true) @map("is_active")
  createdById String   @map("created_by_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  memberships       UserCompanyMembership[]
  departmentConfigs CompanyDepartmentConfig[]
  documents         Document[]

  @@map("companies")
}

// Multi-company membership with rank and department access
model UserCompanyMembership {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  companyId String   @map("company_id")
  rank      Int?     // 1-3, only for CLIENT_EMPLOYEE and FIN_EMPLOYEE
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user               User                         @relation(fields: [userId], references: [id], onDelete: Cascade)
  company            Company                      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  allowedDepartments MembershipDepartmentAccess[]

  @@unique([userId, companyId])
  @@map("user_company_memberships")
}

// ============================================
// GLOBAL DEPARTMENTS
// ============================================

// Platform-wide departments (shared across all companies)
model GlobalDepartment {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  companyConfigs   CompanyDepartmentConfig[]
  membershipAccess MembershipDepartmentAccess[]
  messages         Message[]
  files            File[]
  documents        Document[]

  @@map("global_departments")
}

// Company-specific department configuration (enable/disable)
model CompanyDepartmentConfig {
  id                 String   @id @default(cuid())
  companyId          String   @map("company_id")
  globalDepartmentId String   @map("global_department_id")
  isEnabled          Boolean  @default(true) @map("is_enabled")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  company          Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  globalDepartment GlobalDepartment @relation(fields: [globalDepartmentId], references: [id], onDelete: Cascade)

  @@unique([companyId, globalDepartmentId])
  @@map("company_department_configs")
}

// Junction table for membership -> departments access
model MembershipDepartmentAccess {
  id                      String   @id @default(cuid())
  userCompanyMembershipId String   @map("user_company_membership_id")
  globalDepartmentId      String   @map("global_department_id")
  createdAt               DateTime @default(now()) @map("created_at")

  // Relations
  membership       UserCompanyMembership @relation(fields: [userCompanyMembershipId], references: [id], onDelete: Cascade)
  globalDepartment GlobalDepartment      @relation(fields: [globalDepartmentId], references: [id], onDelete: Cascade)

  @@unique([userCompanyMembershipId, globalDepartmentId])
  @@map("membership_department_access")
}

// ============================================
// DOCUMENTS (separate from Messages)
// ============================================

model Document {
  id                 String         @id @default(cuid())
  globalDepartmentId String         @map("global_department_id")
  companyId          String         @map("company_id")
  documentName       String         @map("document_name")
  documentNumber     String         @map("document_number")
  status             DocumentStatus @default(PENDING)
  rejectionReason    String?        @map("rejection_reason")
  createdById        String         @map("created_by_id")
  approvedById       String?        @map("approved_by_id")
  approvedAt         DateTime?      @map("approved_at")
  expiresAt          DateTime       @map("expires_at") // createdAt + 10 days
  createdAt          DateTime       @default(now()) @map("created_at")
  updatedAt          DateTime       @updatedAt @map("updated_at")

  // Relations
  globalDepartment GlobalDepartment    @relation(fields: [globalDepartmentId], references: [id])
  company          Company             @relation(fields: [companyId], references: [id])
  createdBy        User                @relation("DocumentCreator", fields: [createdById], references: [id])
  approvedBy       User?               @relation("DocumentApprover", fields: [approvedById], references: [id])
  files            File[]
  actionLogs       DocumentActionLog[]
  messageForwards  MessageForward[]

  @@map("documents")
}

// Document action audit log (immutable)
model DocumentActionLog {
  id         String   @id @default(cuid())
  documentId String   @map("document_id")
  userId     String   @map("user_id")
  action     String // CREATED, ACCEPTED, REJECTED, AUTO_EXPIRED, FORWARDED
  details    Json?
  ipAddress  String?  @map("ip_address")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@map("document_action_logs")
}

// ============================================
// MESSAGES & CHAT
// ============================================

model Message {
  id                 String        @id @default(cuid())
  globalDepartmentId String        @map("global_department_id")
  companyId          String        @map("company_id")
  senderId           String        @map("sender_id")
  content            String?
  type               MessageType   @default(TEXT)
  voiceDuration      Int?          @map("voice_duration") // seconds (for voice messages)
  replyToId          String?       @map("reply_to_id")
  isDeleted          Boolean       @default(false) @map("is_deleted")
  deletedAt          DateTime?     @map("deleted_at")
  deletedBy          String?       @map("deleted_by")
  isEdited           Boolean       @default(false) @map("is_edited")
  parentId           String?       @map("parent_id")
  status             MessageStatus @default(SENT)
  isOutgoing         Boolean       @default(true) @map("is_outgoing")
  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @updatedAt @map("updated_at")

  // Relations
  globalDepartment GlobalDepartment @relation(fields: [globalDepartmentId], references: [id])
  sender           User             @relation("SentMessages", fields: [senderId], references: [id])
  replyTo          Message?         @relation("MessageReplies", fields: [replyToId], references: [id])
  replies          Message[]        @relation("MessageReplies")
  parent           Message?         @relation("MessageVersions", fields: [parentId], references: [id])
  versions         Message[]        @relation("MessageVersions")
  files            File[]
  forwards         MessageForward[]
  edits            MessageEdit[]

  @@map("messages")
}

model MessageEdit {
  id        String   @id @default(cuid())
  messageId String   @map("message_id")
  content   String // previous text
  editedAt  DateTime @default(now()) @map("edited_at")

  // Relations
  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@map("message_edits")
}

model MessageForward {
  id                   String   @id @default(cuid())
  messageId            String   @map("message_id")
  documentId           String?  @map("document_id")
  fromDepartmentId     String   @map("from_department_id")
  toDepartmentId       String   @map("to_department_id")
  forwardedBy          String   @map("forwarded_by")
  documentNumber       String?  @map("document_number")
  note                 String?
  createdAt            DateTime @default(now()) @map("created_at")

  // Relations
  message  Message   @relation(fields: [messageId], references: [id], onDelete: Cascade)
  document Document? @relation(fields: [documentId], references: [id])

  @@map("message_forwards")
}

// ============================================
// FILES
// ============================================

model File {
  id                 String     @id @default(cuid())
  globalDepartmentId String?    @map("global_department_id")
  messageId          String?    @map("message_id")
  documentId         String?    @map("document_id")
  uploadedBy         String     @map("uploaded_by")
  originalName       String     @map("original_name")
  fileName           String     @map("file_name") // UUID-based name
  fileSize           Int        @map("file_size")
  mimeType           String     @map("mime_type")
  fileType           FileType   @map("file_type")
  path               String // local path or s3 key
  isOutgoing         Boolean    @default(true) @map("is_outgoing")
  isDeleted          Boolean    @default(false) @map("is_deleted")
  deletedAt          DateTime?  @map("deleted_at")
  deletedBy          String?    @map("deleted_by")
  createdAt          DateTime   @default(now()) @map("created_at")
  updatedAt          DateTime   @updatedAt @map("updated_at")

  // Relations
  globalDepartment GlobalDepartment? @relation(fields: [globalDepartmentId], references: [id])
  message          Message?          @relation(fields: [messageId], references: [id])
  document         Document?         @relation(fields: [documentId], references: [id])
  uploader         User              @relation(fields: [uploadedBy], references: [id])

  @@map("files")
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  title     String
  body      String
  data      Json?
  isRead    Boolean   @default(false) @map("is_read")
  readAt    DateTime? @map("read_at")
  createdAt DateTime  @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

// ============================================
// AUDIT LOGS
// ============================================

model ActionLog {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  companyId String?  @map("company_id")
  action    String
  entity    String
  entityId  String?  @map("entity_id")
  details   Json?
  ipAddress String?  @map("ip_address")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("action_logs")
}

// ============================================
// ARCHIVE TABLES (for messages older than 3 months)
// ============================================

model MessageArchive {
  id                 String        @id
  globalDepartmentId String        @map("global_department_id")
  companyId          String        @map("company_id")
  senderId           String        @map("sender_id")
  content            String?
  type               MessageType
  voiceDuration      Int?          @map("voice_duration")
  replyToId          String?       @map("reply_to_id")
  isDeleted          Boolean       @map("is_deleted")
  deletedAt          DateTime?     @map("deleted_at")
  deletedBy          String?       @map("deleted_by")
  isEdited           Boolean       @map("is_edited")
  parentId           String?       @map("parent_id")
  status             MessageStatus
  isOutgoing         Boolean       @map("is_outgoing")
  createdAt          DateTime      @map("created_at")
  archivedAt         DateTime      @default(now()) @map("archived_at")

  @@map("messages_archive")
}

model FileArchive {
  id                 String     @id
  globalDepartmentId String?    @map("global_department_id")
  messageId          String?    @map("message_id")
  documentId         String?    @map("document_id")
  uploadedBy         String     @map("uploaded_by")
  originalName       String     @map("original_name")
  fileName           String     @map("file_name")
  fileSize           Int        @map("file_size")
  mimeType           String     @map("mime_type")
  fileType           FileType   @map("file_type")
  path               String
  isOutgoing         Boolean    @map("is_outgoing")
  isDeleted          Boolean    @map("is_deleted")
  deletedAt          DateTime?  @map("deleted_at")
  deletedBy          String?    @map("deleted_by")
  createdAt          DateTime   @map("created_at")
  archivedAt         DateTime   @default(now()) @map("archived_at")

  @@map("files_archive")
}

model DocumentArchive {
  id                 String         @id
  globalDepartmentId String         @map("global_department_id")
  companyId          String         @map("company_id")
  documentName       String         @map("document_name")
  documentNumber     String         @map("document_number")
  status             DocumentStatus
  rejectionReason    String?        @map("rejection_reason")
  createdById        String         @map("created_by_id")
  approvedById       String?        @map("approved_by_id")
  approvedAt         DateTime?      @map("approved_at")
  expiresAt          DateTime       @map("expires_at")
  createdAt          DateTime       @map("created_at")
  archivedAt         DateTime       @default(now()) @map("archived_at")

  @@map("documents_archive")
}
