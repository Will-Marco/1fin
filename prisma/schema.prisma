generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum Role {
  SUPER_ADMIN
  ADMIN
  OPERATOR
  FOUNDER
  DIRECTOR
  EMPLOYEE
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
}

enum FileStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum FileType {
  IMAGE
  DOCUMENT
  VOICE
  OTHER
}

enum MessageType {
  TEXT
  FILE
  VOICE
  DOCUMENT // tasdiqlash kerak bo'lgan hujjat
}

enum DocumentStatus {
  PENDING
  APPROVED
  REJECTED
}

// ============================================
// MODELS
// ============================================

model User {
  id                 String   @id @default(cuid())
  username           String   @unique
  password           String
  name               String
  phone              String?
  avatar             String?
  role               Role
  workerTypeId       String?  @map("worker_type_id")
  mustChangePassword Boolean  @default(false) @map("must_change_password")
  isActive           Boolean  @default(true) @map("is_active")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  workerType         WorkerType?        @relation(fields: [workerTypeId], references: [id])
  userCompanies      UserCompany[]
  operatorCompanies  OperatorCompany[]
  sessions           Session[]
  sentMessages       Message[]          @relation("SentMessages")
  files              File[]
  notifications      Notification[]
  departmentMembers  DepartmentMember[]
  approvedDocuments  DocumentApproval[] @relation("DocumentApprover")

  @@map("users")
}

model WorkerType {
  id        String   @id @default(cuid())
  name      String   @unique
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  users User[]

  @@map("worker_types")
}

model Company {
  id        String   @id @default(cuid())
  name      String
  inn       String?  @unique
  logo      String?
  address   String?
  requisites Json?
  isActive  Boolean  @default(true) @map("is_active")
  createdById String @map("created_by_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  userCompanies     UserCompany[]
  operatorCompanies OperatorCompany[]
  departments       Department[]

  @@map("companies")
}

// FOUNDER, DIRECTOR, EMPLOYEE → kompaniyaga bog'lanish
model UserCompany {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  companyId String   @map("company_id")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId])
  @@map("user_companies")
}

// OPERATOR → kompaniyalarga xizmat ko'rsatish
model OperatorCompany {
  id         String   @id @default(cuid())
  operatorId String   @map("operator_id")
  companyId  String   @map("company_id")
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  operator User    @relation(fields: [operatorId], references: [id], onDelete: Cascade)
  company  Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([operatorId, companyId])
  @@map("operator_companies")
}

model Department {
  id        String   @id @default(cuid())
  companyId String   @map("company_id")
  name      String
  slug      String
  isDefault Boolean  @default(false) @map("is_default")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  company  Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  members  DepartmentMember[]
  messages Message[]
  files    File[]

  @@unique([companyId, slug])
  @@map("departments")
}

model DepartmentMember {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  departmentId String   @map("department_id")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  department Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@unique([userId, departmentId])
  @@map("department_members")
}

model Session {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  deviceName   String   @map("device_name")
  deviceType   String   @map("device_type")
  refreshToken String   @map("refresh_token")
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  lastActiveAt DateTime @default(now()) @map("last_active_at")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Message {
  id            String        @id @default(cuid())
  departmentId  String        @map("department_id")
  senderId      String        @map("sender_id")
  content       String?
  type          MessageType   @default(TEXT)
  voiceDuration Int?          @map("voice_duration") // sekundlarda (ovozli xabar uchun)
  replyToId     String?       @map("reply_to_id")
  isDeleted     Boolean       @default(false) @map("is_deleted")
  deletedAt     DateTime?     @map("deleted_at")
  deletedBy     String?       @map("deleted_by")
  isEdited      Boolean       @default(false) @map("is_edited")
  parentId      String?       @map("parent_id")
  status        MessageStatus @default(SENT)
  isOutgoing    Boolean       @default(true) @map("is_outgoing")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  // Relations
  department       Department        @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  sender           User              @relation("SentMessages", fields: [senderId], references: [id])
  replyTo          Message?          @relation("MessageReplies", fields: [replyToId], references: [id])
  replies          Message[]         @relation("MessageReplies")
  parent           Message?          @relation("MessageVersions", fields: [parentId], references: [id])
  versions         Message[]         @relation("MessageVersions")
  files            File[]
  forwards         MessageForward[]
  edits            MessageEdit[]
  documentApproval DocumentApproval?

  @@map("messages")
}

model MessageEdit {
  id        String   @id @default(cuid())
  messageId String   @map("message_id")
  content   String   // oldingi matn
  editedAt  DateTime @default(now()) @map("edited_at")

  // Relations
  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@map("message_edits")
}

model DocumentApproval {
  id              String         @id @default(cuid())
  messageId       String         @unique @map("message_id")
  documentName    String         @map("document_name")
  documentNumber  String         @map("document_number")
  status          DocumentStatus @default(PENDING)
  rejectionReason String?        @map("rejection_reason")
  approvedBy      String?        @map("approved_by")
  approvedAt      DateTime?      @map("approved_at")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  // Relations
  message  Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  approver User?   @relation("DocumentApprover", fields: [approvedBy], references: [id])

  @@map("document_approvals")
}

model MessageForward {
  id               String   @id @default(cuid())
  messageId        String   @map("message_id")
  fromDepartmentId String   @map("from_department_id")
  toDepartmentId   String   @map("to_department_id")
  forwardedBy      String   @map("forwarded_by")
  documentNumber   String?  @map("document_number")
  note             String?
  createdAt        DateTime @default(now()) @map("created_at")

  // Relations
  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@map("message_forwards")
}

model File {
  id             String     @id @default(cuid())
  departmentId   String?    @map("department_id")
  messageId      String?    @map("message_id")
  uploadedBy     String     @map("uploaded_by")
  originalName   String     @map("original_name")
  fileName       String     @map("file_name") // UUID bilan saqlangan nom
  fileSize       Int        @map("file_size")
  mimeType       String     @map("mime_type")
  fileType       FileType   @map("file_type")
  path           String     // local path yoki s3 key
  documentNumber String?    @map("document_number")
  reminderDate   DateTime?  @map("reminder_date")
  status         FileStatus @default(PENDING)
  acceptedBy     String?    @map("accepted_by")
  acceptedAt     DateTime?  @map("accepted_at")
  rejectedBy     String?    @map("rejected_by")
  rejectedAt     DateTime?  @map("rejected_at")
  isOutgoing     Boolean    @default(true) @map("is_outgoing")
  isDeleted      Boolean    @default(false) @map("is_deleted")
  deletedAt      DateTime?  @map("deleted_at")
  deletedBy      String?    @map("deleted_by")
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")

  // Relations
  department Department? @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  message    Message?    @relation(fields: [messageId], references: [id])
  uploader   User        @relation(fields: [uploadedBy], references: [id])

  @@map("files")
}

model Notification {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  title     String
  body      String
  data      Json?
  isRead    Boolean   @default(false) @map("is_read")
  readAt    DateTime? @map("read_at")
  createdAt DateTime  @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model ActionLog {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  companyId String?  @map("company_id")
  action    String
  entity    String
  entityId  String?  @map("entity_id")
  details   Json?
  ipAddress String?  @map("ip_address")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("action_logs")
}

// ============================================
// ARCHIVE TABLES (for messages older than 3 months)
// ============================================

model MessageArchive {
  id           String        @id
  departmentId String        @map("department_id")
  senderId     String        @map("sender_id")
  content      String?
  isDeleted    Boolean       @map("is_deleted")
  deletedAt    DateTime?     @map("deleted_at")
  deletedBy    String?       @map("deleted_by")
  isEdited     Boolean       @map("is_edited")
  parentId     String?       @map("parent_id")
  status       MessageStatus
  isOutgoing   Boolean       @map("is_outgoing")
  createdAt    DateTime      @map("created_at")
  archivedAt   DateTime      @default(now()) @map("archived_at")

  @@map("messages_archive")
}
